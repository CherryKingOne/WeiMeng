# WeiMeng-Agent 后端项目重构方案

## ✅ 重构状态：已完成

---

## 一、当前项目问题分析

### 1. 模块命名不规范
- `captchaSend` 使用驼峰命名，不符合 Python 的 snake_case 规范
- 模块命名风格不统一（login/register 是名词，captchaSend 是动词短语）

### 2. DDD 分层架构不完整
- `infrastructure/` 目录存在但为空，分层架构只是形式上的
- 缺少 `domain/` 层，业务逻辑与数据访问耦合
- 缺少 `repository/` 层来封装数据访问

### 3. 职责划分混乱
- `core/models.py` 集中存放所有 ORM 模型，随着项目增长会变得臃肿
- Service 层直接操作数据库和 Redis，违反单一职责原则
- 邮件 HTML 模板硬编码在 Service 中，难以维护

### 4. 依赖注入不统一
- `AuthService`、`RegisterService` 通过构造函数注入 db session
- `ResetPasswordService` 没有注入，直接在方法参数中接收
- Redis 使用全局单例，不利于测试和依赖注入

### 5. 代码重复严重
- `send_email_captcha` 和 `send_forgot_password_captcha` 有 80% 重复代码
- 验证码校验逻辑在 `RegisterService` 和 `ResetPasswordService` 中重复

### 6. 缺少基础设施层
- 没有统一的响应格式封装
- 没有全局异常处理机制
- 缺少日志记录中间件
- JWT 工具代码混在 Service 中

### 7. 配置管理问题
- 所有配置集中在一个 `Settings` 类，未来会变得庞大
- 没有按功能模块拆分配置

### 8. 缺少测试结构
- 没有测试目录
- 当前结构不利于单元测试

---

## 二、新目录结构设计

```
backend/
├── main.py                              # FastAPI 应用入口
├── pyproject.toml                       # 项目配置
├── requirements.txt                     # 依赖列表
├── Dockerfile
├── docker-compose.yml
├── .env.example
│
├── config/                              # 配置文件目录
│   ├── __init__.py
│   ├── settings.py                      # 主配置入口
│   ├── database.py                      # 数据库配置
│   ├── redis.py                         # Redis 配置
│   ├── email.py                         # 邮件服务配置
│   └── ai.py                            # AI 服务配置
│
├── src/                                 # 源代码目录
│   ├── __init__.py
│   │
│   ├── shared/                          # 共享模块（跨模块通用）
│   │   ├── __init__.py
│   │   │
│   │   ├── domain/                      # 领域基类与通用值对象
│   │   │   ├── __init__.py
│   │   │   ├── base_entity.py           # 实体基类
│   │   │   ├── base_value_object.py     # 值对象基类
│   │   │   └── exceptions.py            # 领域异常
│   │   │
│   │   ├── infrastructure/              # 基础设施层
│   │   │   ├── __init__.py
│   │   │   ├── database.py              # 数据库连接与会话管理
│   │   │   ├── redis.py                 # Redis 客户端
│   │   │   └── unit_of_work.py          # 工作单元模式
│   │   │
│   │   ├── security/                    # 安全相关
│   │   │   ├── __init__.py
│   │   │   ├── password_hasher.py       # 密码哈希
│   │   │   └── jwt_handler.py           # JWT 处理
│   │   │
│   │   ├── middleware/                  # 中间件
│   │   │   ├── __init__.py
│   │   │   ├── logging.py               # 日志中间件
│   │   │   ├── error_handler.py         # 全局异常处理
│   │   │   └── request_context.py       # 请求上下文
│   │   │
│   │   ├── common/                      # 通用工具
│   │   │   ├── __init__.py
│   │   │   ├── response.py              # 统一响应格式
│   │   │   ├── dependencies.py          # 通用依赖注入
│   │   │   └── utils.py                 # 工具函数
│   │   │
│   │   └── extensions/                  # 扩展模块
│   │       ├── __init__.py
│   │       └── email/                   # 邮件扩展
│   │           ├── __init__.py
│   │           ├── sender.py            # 邮件发送器
│   │           └── templates/           # 邮件模板
│   │               ├── __init__.py
│   │               ├── base.html        # 基础模板
│   │               ├── captcha.html     # 验证码模板
│   │               └── reset_password.html
│   │
│   ├── modules/                         # 业务模块（按领域划分）
│   │   ├── __init__.py
│   │   │
│   │   ├── auth/                        # 认证模块（整合 login/register/reset_password）
│   │   │   ├── __init__.py
│   │   │   │
│   │   │   ├── domain/                  # 领域层
│   │   │   │   ├── __init__.py
│   │   │   │   ├── entities/            # 实体
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   └── user.py          # 用户实体
│   │   │   │   ├── value_objects/       # 值对象
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   └── token.py         # Token 值对象
│   │   │   │   ├── services/            # 领域服务
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   └── authentication_service.py
│   │   │   │   ├── repositories.py      # 仓储接口
│   │   │   │   └── exceptions.py        # 领域异常
│   │   │   │
│   │   │   ├── application/             # 应用层
│   │   │   │   ├── __init__.py
│   │   │   │   ├── services/            # 应用服务
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── login_service.py
│   │   │   │   │   ├── register_service.py
│   │   │   │   │   └── reset_password_service.py
│   │   │   │   └── dto/                 # 数据传输对象
│   │   │   │       ├── __init__.py
│   │   │   │       ├── login_dto.py
│   │   │   │       ├── register_dto.py
│   │   │   │       └── reset_password_dto.py
│   │   │   │
│   │   │   ├── infrastructure/          # 基础设施层
│   │   │   │   ├── __init__.py
│   │   │   │   ├── models/              # ORM 模型
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   └── user_model.py
│   │   │   │   ├── repositories/        # 仓储实现
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   └── user_repository.py
│   │   │   │   └── mappers/             # 对象映射器
│   │   │   │       ├── __init__.py
│   │   │   │       └── user_mapper.py
│   │   │   │
│   │   │   └── api/                     # 接口层
│   │   │       ├── __init__.py
│   │   │       ├── router.py            # 路由定义
│   │   │       └── dependencies.py      # 模块依赖注入
│   │   │
│   │   ├── captcha/                     # 验证码模块
│   │   │   ├── __init__.py
│   │   │   │
│   │   │   ├── domain/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── entities/
│   │   │   │   │   └── captcha.py
│   │   │   │   ├── services/
│   │   │   │   │   └── captcha_service.py
│   │   │   │   ├── repositories.py
│   │   │   │   └── exceptions.py
│   │   │   │
│   │   │   ├── application/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── services/
│   │   │   │   │   └── email_captcha_service.py
│   │   │   │   └── dto/
│   │   │   │       └── captcha_dto.py
│   │   │   │
│   │   │   ├── infrastructure/
│   │   │   │   ├── __init__.py
│   │   │   │   └── repositories/
│   │   │   │       └── captcha_repository.py
│   │   │   │
│   │   │   └── api/
│   │   │       ├── __init__.py
│   │   │       ├── router.py
│   │   │       └── dependencies.py
│   │   │
│   │   └── agent/                       # Agent 模块（预留）
│   │       ├── __init__.py
│   │       ├── domain/
│   │       ├── application/
│   │       ├── infrastructure/
│   │       └── api/
│   │
│   └── api/                             # API 入口
│       ├── __init__.py
│       ├── v1/                          # API 版本控制
│       │   ├── __init__.py
│       │   └── router.py                # 汇总所有 v1 路由
│       └── deps.py                      # 全局依赖
│
└── tests/                               # 测试目录
    ├── __init__.py
    ├── conftest.py                      # pytest 配置
    ├── unit/                            # 单元测试
    │   ├── __init__.py
    │   ├── test_auth/
    │   └── test_captcha/
    ├── integration/                     # 集成测试
    │   ├── __init__.py
    │   └── test_api/
    └── fixtures/                        # 测试数据
        ├── __init__.py
        └── user_fixtures.py
```

---

## 三、分层架构说明

### 1. Domain 层（领域层）
- **职责**：包含业务核心逻辑，不依赖任何外部框架
- **内容**：
  - `entities/` - 实体类，具有唯一标识
  - `value_objects/` - 值对象，无标识的不可变对象
  - `services/` - 领域服务，跨实体的业务逻辑
  - `repositories.py` - 仓储接口定义
  - `exceptions.py` - 领域异常

### 2. Application 层（应用层）
- **职责**：协调领域对象完成用例，处理事务
- **内容**：
  - `services/` - 应用服务，编排业务流程
  - `dto/` - 数据传输对象，API 层与应用层交互

### 3. Infrastructure 层（基础设施层）
- **职责**：实现技术细节，如数据库访问、外部服务调用
- **内容**：
  - `models/` - ORM 模型
  - `repositories/` - 仓储实现，封装数据访问
  - `mappers/` - 领域对象与 ORM 对象的映射

### 4. API 层（接口层）
- **职责**：处理 HTTP 请求/响应，参数校验
- **内容**：
  - `router.py` - 路由定义
  - `dependencies.py` - 依赖注入配置

---

## 四、模块划分原则

### 1. 认证模块 (auth)
整合原有的 login、register、reset_password，因为它们：
- 共享用户实体
- 业务逻辑紧密相关
- 减少模块间依赖

### 2. 验证码模块 (captcha)
独立模块，因为：
- 可被多个模块复用（注册、登录、重置密码）
- 有独立的存储机制（Redis）
- 未来可能扩展短信验证码

### 3. Agent 模块
预留位置，按相同分层结构组织

---

## 五、已完成的重构工作

### ✅ 阶段一：基础设施搭建
- [x] 创建新的目录结构
- [x] 实现 `shared/` 模块
  - [x] domain 层（base_entity, base_value_object, exceptions）
  - [x] infrastructure 层（database, redis, unit_of_work）
  - [x] security 层（password_hasher, jwt_handler）
  - [x] middleware 层（error_handler, logging, request_context）
  - [x] common 层（response, dependencies, utils）
  - [x] extensions/email 层（sender, templates）
- [x] 配置拆分与迁移
  - [x] database.py
  - [x] redis.py
  - [x] email.py
  - [x] ai.py
  - [x] settings.py

### ✅ 阶段二：认证模块重构
- [x] 实现 Domain 层
  - [x] entities/user.py
  - [x] value_objects/token.py
  - [x] services/authentication_service.py
  - [x] repositories.py
  - [x] exceptions.py
- [x] 实现 Infrastructure 层
  - [x] models/user_model.py
  - [x] repositories/user_repository.py
  - [x] mappers/user_mapper.py
- [x] 实现 Application 层
  - [x] services/login_service.py
  - [x] services/register_service.py
  - [x] services/reset_password_service.py
  - [x] dto/login_dto.py
  - [x] dto/register_dto.py
  - [x] dto/reset_password_dto.py
- [x] 实现 API 层
  - [x] router.py
  - [x] dependencies.py

### ✅ 阶段三：验证码模块重构
- [x] 实现 Domain 层
  - [x] entities/captcha.py
  - [x] services/captcha_service.py
  - [x] repositories.py
  - [x] exceptions.py
- [x] 实现 Infrastructure 层
  - [x] repositories/captcha_repository.py
- [x] 实现 Application 层
  - [x] services/email_captcha_service.py
  - [x] dto/captcha_dto.py
- [x] 实现 API 层
  - [x] router.py
  - [x] dependencies.py

### ✅ 阶段四：清理与验证
- [x] 删除旧的代码目录（core, login, register, reset_password, captchaSend）
- [x] 验证项目可以正常启动
- [x] 验证所有路由正确注册

---

## 六、API 端点列表

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | `/api/v1/auth/login` | 用户登录 |
| POST | `/api/v1/auth/register` | 用户注册 |
| POST | `/api/v1/auth/reset-password` | 重置密码 |
| POST | `/api/v1/captcha/email/send` | 发送登录验证码 |
| POST | `/api/v1/captcha/email/forgot-password` | 发送重置密码验证码 |
| GET | `/health` | 健康检查 |

---

## 七、后续建议

### 1. 测试
- 为每个模块编写单元测试
- 编写 API 集成测试
- 配置 CI/CD 自动测试

### 2. 文档
- 完善 API 文档
- 添加架构说明文档
- 添加开发指南

### 3. 功能扩展
- 实现 Agent 模块
- 添加用户权限管理
- 添加 API 限流
- 添加请求日志追踪

---

## 八、环境变量配置

参考 `.env.example` 文件：

```bash
# App
APP_ENV=development
APP_NAME=WeiMeng
SECRET_KEY=super-secret-key-change-it
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_DAYS=30

# Database
POSTGRESQL_HOST=localhost
POSTGRESQL_PORT=5432
POSTGRESQL_USER=postgres
POSTGRESQL_PASSWORD=password
POSTGRESQL_DB=weimeng

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# SMTP Email
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=user@example.com
SMTP_PASSWORD=secret
SMTP_USE_TLS=True
SMTP_FROM_NAME=WeiMeng

# AI Services
OPENAI_API_KEY=sk-your-openai-key
LANGFUSE_SECRET_KEY=sk-lf-placeholder
LANGFUSE_PUBLIC_KEY=pk-lf-placeholder
```

---

**重构完成时间：2026-02-13**
